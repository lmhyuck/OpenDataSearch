<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì „êµ­ ì „í†µì‹œì¥ ê²€ìƒ‰ ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <div class="container">
      <h1>ğŸª ì „í†µì‹œì¥ ì‹¤ì‹œê°„ ê²€ìƒ‰</h1>
      <div class="search-box">
        <input
          type="text"
          id="query"
          placeholder="ì‹œì¥ëª…, ì£¼ì†Œ ë“±ì„ ì…ë ¥í•˜ì„¸ìš”..."
          onkeyup="if(window.event.keyCode==13){newSearch()}"
        />
        <button onclick="newSearch()">ê²€ìƒ‰</button>
      </div>

      <div
        id="loading"
        style="display: none; text-align: center; padding: 20px"
      >
        ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
      </div>

      <div id="results" class="results"></div>

      <div
        class="pagination"
        id="pagination"
        style="
          display: none;
          margin-top: 30px;
          display: flex;
          justify-content: center;
          gap: 15px;
          align-items: center;
        "
      >
        <button id="prevBtn" onclick="changePage(-1)">ì´ì „</button>
        <span id="pageInfo" style="font-weight: bold">1</span>
        <button id="nextBtn" onclick="changePage(1)">ë‹¤ìŒ</button>
      </div>
    </div>

    <script>
      let currentPage = 1;
      let currentQuery = "";

      async function newSearch() {
        const q = document.getElementById("query").value;
        if (!q.trim()) {
          alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
          return;
        }
        currentQuery = q;
        currentPage = 1;
        await fetchData();
      }

      async function changePage(offset) {
        currentPage += offset;
        await fetchData();
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      async function fetchData() {
        const resultsDiv = document.getElementById("results");
        const loading = document.getElementById("loading");
        const pagination = document.getElementById("pagination");

        // UI ì´ˆê¸°í™”
        resultsDiv.innerHTML = "";
        loading.style.display = "block";
        pagination.style.display = "none";

        try {
          // ê´€ë¦¬ìë‹˜ ì „ìš© 8000ë²ˆ í¬íŠ¸ í˜¸ì¶œ
          const url = `http://127.0.0.1:8000/search?q=${encodeURIComponent(
            currentQuery
          )}&page=${currentPage}`;
          console.log("ğŸ“¡ ìš”ì²­ URL:", url);

          const response = await fetch(url);

          if (!response.ok) {
            throw new Error(`HTTP ì—ëŸ¬! ìƒíƒœì½”ë“œ: ${response.status}`);
          }

          const data = await response.json();
          console.log("âœ… ìˆ˜ì‹  ì„±ê³µ ë°ì´í„°:", data);

          loading.style.display = "none";

          // API ì‘ë‹µ êµ¬ì¡° ë°©ì–´ ë¡œì§ (items í•„ë“œê°€ ì—†ì„ ê²½ìš° ëŒ€ë¹„)
          const items = data.items || [];

          if (items.length === 0) {
            resultsDiv.innerHTML =
              '<div class="item">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
          }

          // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
          resultsDiv.innerHTML = items
            .map(
              (item) => `
                    <div class="item" style="background:white; padding:15px; border-radius:8px; margin-bottom:10px; border:1px solid #eee;">
                        <div class="title" style="font-size:1.2rem; font-weight:bold; color:#2563eb;">${
                          item.market_name || "ì´ë¦„ ì •ë³´ ì—†ìŒ"
                        }</div>
                        <div class="desc" style="margin-top:5px; color:#444;">
                            ğŸ“ ë„ë¡œëª…: ${item.address_road || "ì •ë³´ ì—†ìŒ"}<br>
                            ğŸ  ì§€ë²ˆ: ${item.address_jibun || "ì •ë³´ ì—†ìŒ"}
                        </div>
                        <div style="margin-top:10px; font-size:0.8rem; color:#999;">
                            # ${item.items_sold || "ê¸°íƒ€"} | ID: ${
                item.market_id
              }
                        </div>
                    </div>
                `
            )
            .join("");

          // í˜ì´ì§€ë„¤ì´ì…˜ ì œì–´
          pagination.style.display = "flex";
          document.getElementById(
            "pageInfo"
          ).innerText = `í˜ì´ì§€: ${currentPage}`;
          document.getElementById("prevBtn").disabled = currentPage === 1;
          document.getElementById("nextBtn").disabled = !data.has_more;
        } catch (error) {
          loading.style.display = "none";
          console.error("ğŸš¨ ìƒì„¸ ì—ëŸ¬ ë°œìƒ:", error);

          // í™”ë©´ì— ì—ëŸ¬ ì›ì¸ì„ êµ¬ì²´ì ìœ¼ë¡œ í‘œì‹œ
          resultsDiv.innerHTML = `
                    <div style="background:#fee2e2; border:1px solid #ef4444; padding:20px; border-radius:8px; color:#b91c1c;">
                        <strong>âš ï¸ API ì—°ê²° ì˜¤ë¥˜ ë°œìƒ</strong><br>
                        ì›ì¸: ${error.message}<br><br>
                        <small>1. API ì„œë²„ê°€ 8000ë²ˆ í¬íŠ¸ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.<br>
                        2. ë¸Œë¼ìš°ì € ì½˜ì†”(F12)ì˜ Network íƒ­ì—ì„œ ì‘ë‹µ ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”.</small>
                    </div>
                `;
        }
      }
    </script>
  </body>
</html>
